// Author: Hyun Woo Kim 

// Date: 4/16/2024 

// MITRE: T1203 

// TITLE: T1203 - Exploitation on Client Execution - Office365 Apps 

// Description: Detects suspicious network outbound to non-internal IPs with office365 apps 

DeviceNetworkEvents 

| where (InitiatingProcessFolderPath endswith "\\excel.exe" or InitiatingProcessFolderPath endswith "\\powerpnt.exe" or InitiatingProcessFolderPath endswith "\\winword.exe" or InitiatingProcessFolderPath endswith "\\wordview.exe") 

| where RemoteUrl !endswith "microsoft.com" 

| where RemoteUrl !endswith "office.com" 

| where RemoteUrl !endswith "office365.com" 

| where RemoteUrl !endswith "microsoftonline.com"  

| where RemoteUrl !endswith "windows.net" 

| where InitiatingProcessFolderPath != @"c:\program files\microsoft office\root\office16\excel.exe" 

| where InitiatingProcessFolderPath != @"c:\program files\microsoft office\root\office16\winword.exe" 

| where InitiatingProcessFolderPath != @"c:\program files\microsoft office\root\office16\excpowerpntel.exe" 

| where InitiatingProcessFolderPath != @"c:\program files\microsoft office\root\office16\powerpnt.exe" 

| where RemoteUrl !endswith "office.net" 

| where RemoteUrl !endswith "outlook.com" 

| where RemoteUrl !endswith "officeapps.live.com" 

| where RemoteIP !startswith "::ffff" 

| where RemoteUrl !endswith "atlassian.com" 

| where RemoteUrl !endswith "digicert.com" 

| where RemoteUrl !endswith "aadrm.com" 

| where RemoteUrl !endswith "skype.com" 

| where RemoteUrl !endswith "static.microsoft" 

| where RemoteUrl !endswith "microsoftazuread-sso.com" 

| where RemoteUrl !endswith "akamaihd.net" 

| where isnotempty(RemoteUrl) 

| where RemoteUrl != @"excelfunctionstranslator.azurewebsites.net" 

| where RemoteUrl != @"arc.msn.com" 

| where RemoteUrl != @"192664-ipv4v6.gr.global.aa-rt.sharepoint.com" 

| where RemoteUrl !startswith "http://ocsp.digicert.com" 

| where RemoteUrl != "js.monitor.azure.com" 

| where RemoteUrl !endswith "azureedge.net" 

| where RemoteUrl !endswith "powerapps.com" 

 